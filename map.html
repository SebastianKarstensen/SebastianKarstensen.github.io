<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8' />
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <title>Display a map</title>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
        <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width:100%; }
            #location {
                position: absolute;
                bottom: 0;
                left: 0;
                z-index: 100;
                background: white;
                height: 10%;
                width: 100%;
            }

            h2 {
                font-size: 20px;
                margin: 0;
            }

            h3 {
                font-size: 14px;
                margin-top: 5px;
            }

            .info {
                text-align: center;
                float: left;
                margin-top: 10px;
                width: 25%;
            }
            .marker {
              background-size: cover;
              width: 50px;
              height: 50px;
              border-radius: 50%;
              cursor: pointer;
              text-align: center;
              color: white;
              font-weight: bold;
              font-size: 1.8em; 
              background: #8e112a;
            }
            #map-center { position:absolute; margin:0; top:50%; left:50%; z-index: 200; transform: translate(-50%, -50%);}
        </style>
    </head>

    <body>
        <div id='map'>

        </div>
        <div id='location'>
            <div class="info">
                <h2>Latitude</h2>
                <h3 id="latitude">...</h3>
            </div>
            <div class="info">
                <h2>Longitude</h2>
                <h3 id="longitude">...</h3>
            </div>
            <div class="info">
                <h2>Distance</h2>
                <h3 id="distance">...</h3>
            </div>
            <div class="info">
                <h2>Time</h2>
                <h3 id="time">0</h3>
            </div>

        </div>
        <h1 id="map-center">+</h1>

        <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
        <script>
            var checkpointRadius = 0.01; //in km

            var bounds = [
                [12.49871, 55.63100],  // Southwest coordinates
                [12.66089, 55.72603]   // Northeast coordinates
            ];

            var userPositionLat = 55.712836;
            var userPositionLon = 12.568950;

            var latitudeLabel = document.getElementById("latitude");
            var longitudeLabel = document.getElementById("longitude");
            var distanceLabel = document.getElementById("distance");
            var timeLabel = document.getElementById("time");

            var route = [
              [12.567050, 55.712736],
              [12.567050, 55.712236],
              [12.568950, 55.712336],
              [12.568950, 55.712836]
            ];

            /*
            var route = [
                [12.57026, 55.70746],
                [12.57035, 55.70666],
                [12.56834, 55.70549],
                [12.56579, 55.70602],
                [12.56617, 55.70655],
                [12.56787, 55.70683],
                [12.56907, 55.70701],
                [12.57006, 55.7075]
            ];
            */

            var currentCheckpoint = 0;
            var seconds = 0;
            var timer;
            var markers = [];

            //Access Token
            mapboxgl.accessToken = 'pk.eyJ1Ijoic2ViYXN0aWFua2Fyc3RlbnNlbiIsImEiOiJjamV5OTBlbDkwZjZ1MnFtbjN4aDY5NncwIn0.LcAIpQNucHR6-pXfL5vnMw';

            //Create Map
            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/sebastiankarstensen/cjf0wbvqh6hmq2rpajw1jl19u', // stylesheet location
                center: [userPositionLon, userPositionLat], // starting position [lng, lat]
                zoom: 16, // starting zoom
                maxBounds: bounds // Sets bounds as max 
            });

            // Add geolocate control to the map.
            var geocontrol = new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            });
            map.addControl(geocontrol);

            //Update user position whenever they move
            geocontrol.on('geolocate', function(e) {
                updatePosition(e.coords.latitude, e.coords.longitude);
            });


            function createRoute(coordinates) {
                var points = [];
                for (var i = 0; i < coordinates.length; i++) {
                    var feature = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [coordinates[i][0], coordinates[i][1]] //lon, lat
                        },
                        properties: {
                            title: 'Checkpoint',
                            size: [20, 20],
                            type: 'Race'
                        }
                    };
                    points.push(feature);
                }

                var json = {
                  type: 'FeatureCollection',
                  features: points
                };

                return json;
                // body...
            }

            var geojson = createRoute(route);

            //MARKERS
            /*
            var geojson = {
              type: 'FeatureCollection',
              features: [{
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: [12.570372, 55.707717] //lon, lat
                },
                properties: {
                  title: 'Checkpoint',
                  size: [20, 20],
                  type: 'Race'
                }
              },
              {
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: [12.568341, 55.705485] //lon, lat
                },
                properties: {
                  title: 'Mapbox',
                  size: [40, 40],
                  type: 'Race'
                }
              },
              {
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: [12.568950, 55.712836] //lon, lat
                },
                properties: {
                  title: 'Home',
                  size: [30, 30],
                  type: 'Other'
                }
              }]
            };
            */

            function addRoute() {
              geojson.features.forEach(function(marker, index) {
                // create a HTML element for each feature
                var el = document.createElement('div');
                el.innerHTML = index;
                el.className = 'marker';
                el.style.width = marker.properties.size[0] + 'px';
                el.style.height = marker.properties.size[1] + 'px';
                el.style.backgroundImage = "url(" + marker.properties.type + ".png)";

                // make a marker for each feature and add to the map
                markers.push(new mapboxgl.Marker(el).setLngLat(marker.geometry.coordinates).addTo(map));
              });
            }

            addRoute();

            //Updates the local variables of user position and moves map
            function updatePosition(lat, lon) {
                userPositionLat = lat;
                userPositionLon = lon;
                latitudeLabel.innerHTML = lat.toFixed(4);
                longitudeLabel.innerHTML = lon.toFixed(4);

                map.flyTo({center: [lon, lat]});
                distanceToCheckpoint = turf.distance(
                    {type: 'Feature', geometry: {type: 'Point', coordinates: [userPositionLon, userPositionLat] }},
                    {type: 'Feature', geometry: {type: 'Point', coordinates: route[currentCheckpoint] }}, 
                );
                if (distanceToCheckpoint < checkpointRadius) { 
                    distance.innerHTML = "CHECKPOINT " + currentCheckpoint;
                    markers[currentCheckpoint].remove();
                    //First checkpoint --> Start the clock
                    if(currentCheckpoint == 0) {
                      //start time
                      time.innerHTML = seconds;
                      timer = setInterval(secondPassed, 100);
                    }
                    
                    if(currentCheckpoint < route.length - 1) {
                      currentCheckpoint++;
                    }
                    else {
                      //stop time
                      clearInterval(timer);
                      currentCheckpoint = 0;
                      seconds = 0;
                      markers = [];
                      addRoute();
                    }
                }
                else {distance.innerHTML = distanceToCheckpoint.toFixed(4)}
            }

            document.body.onkeydown = function(e){
                switch(e.keyCode) {
                    case 65:
                        updatePosition(userPositionLat, userPositionLon - 0.0001);
                        break;
                    case 87:
                        updatePosition(userPositionLat + 0.0001, userPositionLon);
                        break;
                    case 68:
                        updatePosition(userPositionLat, userPositionLon + 0.0001);
                        break;
                    case 83:
                        updatePosition(userPositionLat - 0.0001, userPositionLon);
                        break;
                }
            }

            function secondPassed( )
            {
              seconds += 0.1;
              time.innerHTML = seconds.toFixed(2);
            }
        </script>

    </body>
</html>